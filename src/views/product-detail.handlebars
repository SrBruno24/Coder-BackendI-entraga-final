<div class="container mt-4">
  <div class="row">
    <div class="col-12">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/products">Productos</a></li>
          <li class="breadcrumb-item"><a href="/products?query={{product.category}}">{{product.category}}</a></li>
          <li class="breadcrumb-item active" aria-current="page">{{product.title}}</li>
        </ol>
      </nav>
    </div>
  </div>

  <div class="row">
    <div class="col-lg-6">
      <div class="product-gallery">
        {{#if product.thumbnails.length}}
        <div id="productCarousel" class="carousel slide mb-3" data-bs-ride="carousel">
          <div class="carousel-inner">
            {{#each product.thumbnails}}
            <div class="carousel-item {{#if @first}}active{{/if}}">
              <img src="{{this}}" class="d-block w-100 rounded" alt="{{../product.title}}" style="height: 400px; object-fit: cover;">
            </div>
            {{/each}}
          </div>
          {{#if (gt product.thumbnails.length 1)}}
          <button class="carousel-control-prev" type="button" data-bs-target="#productCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Anterior</span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#productCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Siguiente</span>
          </button>
          {{/if}}
        </div>
        {{else}}
        <div class="bg-light rounded d-flex align-items-center justify-content-center mb-3" style="height: 400px;">
          <div class="text-center">
            <i class="fas fa-image text-muted fa-4x mb-3"></i>
            <p class="text-muted">Sin imagen disponible</p>
          </div>
        </div>
        {{/if}}
      </div>
    </div>

    <div class="col-lg-6">
      <div class="product-info">
        <h1 class="h2 mb-3">{{product.title}}</h1>
        
        <div class="mb-3">
          <span class="badge {{statusBadge product.status}} me-2">{{statusText product.status}}</span>
          <span class="badge bg-secondary">{{product.category}}</span>
        </div>

        <div class="mb-4">
          <span class="h3 text-primary">{{formatPrice product.price}}</span>
        </div>

        <div class="mb-4">
          <h5>Descripción</h5>
          <p class="text-muted">{{product.description}}</p>
        </div>

        <div class="row mb-4">
          <div class="col-6">
            <div class="info-item">
              <strong>Código:</strong>
              <span class="text-muted">{{product.code}}</span>
            </div>
          </div>
          <div class="col-6">
            <div class="info-item">
              <strong>Stock disponible:</strong>
              <span class="text-muted">{{product.stock}} unidades</span>
            </div>
          </div>
        </div>

        <div class="stock-indicator mb-4">
          {{#if (eq product.stock 0)}}
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i>
            Producto sin stock
          </div>
          {{else if (lt product.stock 10)}}
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-circle"></i>
            ¡Últimas {{product.stock}} unidades disponibles!
          </div>
          {{else}}
          <div class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            Producto en stock
          </div>
          {{/if}}
        </div>

        {{#if product.status}}
        <div class="add-to-cart-section">
          <div class="row g-3 mb-3">
            <div class="col-4">
              <label for="quantity" class="form-label">Cantidad</label>
              <input type="number" class="form-control" id="quantity" value="1" min="1" max="{{product.stock}}">
            </div>
            <div class="col-8 d-flex align-items-end">
              <button class="btn btn-success w-100" onclick="addProductToCart('{{product._id}}', '{{product.title}}')">
                <i class="fas fa-cart-plus"></i> Agregar al carrito
              </button>
            </div>
          </div>
          
          <div class="d-grid gap-2">
            <button class="btn btn-outline-primary" onclick="buyNow('{{product._id}}')">
              <i class="fas fa-bolt"></i> Comprar ahora
            </button>
          </div>
        </div>
        {{else}}
        <div class="alert alert-secondary text-center">
          <i class="fas fa-ban"></i>
          Producto no disponible
        </div>
        {{/if}}

        <div class="product-features mt-4">
          <h6>Información adicional:</h6>
          <ul class="list-unstyled">
            <li><i class="fas fa-truck text-muted me-2"></i> Envío gratis en compras mayores a $50.000</li>
            <li><i class="fas fa-shield-alt text-muted me-2"></i> Garantía de 12 meses</li>
            <li><i class="fas fa-undo text-muted me-2"></i> Devolución gratuita hasta 30 días</li>
            <li><i class="fas fa-headset text-muted me-2"></i> Soporte técnico especializado</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-5">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-info-circle"></i> Detalles técnicos
          </h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <table class="table table-borderless">
                <tr>
                  <td><strong>Código del producto:</strong></td>
                  <td>{{product.code}}</td>
                </tr>
                <tr>
                  <td><strong>Categoría:</strong></td>
                  <td>{{product.category}}</td>
                </tr>
                <tr>
                  <td><strong>Estado:</strong></td>
                  <td>{{statusText product.status}}</td>
                </tr>
                <tr>
                  <td><strong>Stock disponible:</strong></td>
                  <td>{{product.stock}} unidades</td>
                </tr>
              </table>
            </div>
            <div class="col-md-6">
              <div class="text-center">
                <div class="border rounded p-3">
                  <i class="fas fa-barcode fa-2x text-muted mb-2"></i>
                  <br>
                  <small class="text-muted">ID del producto</small>
                  <br>
                  <code>{{product._id}}</code>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-3 mb-5">
    <div class="col-12 text-center">
      <a href="/products" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> Volver a productos
      </a>
    </div>
  </div>
</div>

<script>
async function addProductToCart(productId, productTitle) {
  const quantity = parseInt(document.getElementById('quantity').value);
  let cartId = localStorage.getItem('currentCartId');
  
  if (!cartId) {
    try {
      const cartResponse = await fetch('/create-cart', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      const cartData = await cartResponse.json();
      
      if (cartData.status === 'success') {
        cartId = cartData.cartId;
        localStorage.setItem('currentCartId', cartId);
      } else {
        throw new Error('No se pudo crear el carrito');
      }
    } catch (error) {
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'No se pudo crear el carrito: ' + error.message
      });
      return;
    }
  }
  
  try {
    const response = await fetch(`/api/carts/${cartId}/product/${productId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ quantity })
    });
    
    const data = await response.json();
    
    if (data.status === 'success') {
      Swal.fire({
        icon: 'success',
        title: '¡Producto agregado!',
        text: `${productTitle} ha sido agregado al carrito`,
        showCancelButton: true,
        confirmButtonText: 'Ver carrito',
        cancelButtonText: 'Seguir comprando'
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = `/carts/${cartId}`;
        }
      });
    } else {
      throw new Error(data.message);
    }
  } catch (error) {
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'No se pudo agregar el producto: ' + error.message
    });
  }
}

async function buyNow(productId) {
  await addProductToCart(productId, '{{product.title}}');
  
  const cartId = localStorage.getItem('currentCartId');
  if (cartId) {
    window.location.href = `/carts/${cartId}`;
  }
}

document.getElementById('quantity').addEventListener('change', function() {
  const max = parseInt(this.getAttribute('max'));
  const value = parseInt(this.value);
  
  if (value > max) {
    this.value = max;
    Swal.fire({
      icon: 'warning',
      title: 'Cantidad limitada',
      text: `Solo hay ${max} unidades disponibles`,
      showConfirmButton: false,
      timer: 2000
    });
  }
  
  if (value < 1) {
    this.value = 1;
  }
});
</script>

<style>
.product-info .info-item {
  margin-bottom: 0.5rem;
}

.product-gallery .carousel-item img {
  border-radius: 0.375rem;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.stock-indicator .alert {
  border-radius: 0.375rem;
}

.product-features ul li {
  padding: 0.25rem 0;
}

.add-to-cart-section {
  border-top: 1px solid #dee2e6;
  padding-top: 1.5rem;
}

@media (max-width: 768px) {
  .product-info {
    margin-top: 2rem;
  }
}
</style>